@model List<Book_Store.Models.Book>
@{
    Layout = "~/Views/Shared/_Admin_Layout.cshtml";
    ViewData["Title"] = "Sách đã ẩn";
    string q = Context.Request.Query["q"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-categories.css" asp-append-version="true" />
}

<div class="admin-page">
    <div class="page-header">
        <h1 class="page-title">Sách đã ẩn</h1>

        <div class="toolbar">
            <form method="get" class="search-box" asp-action="Hidden">
                <svg class="search-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.3-4.3m1.3-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
                <input name="q" value="@q" placeholder="Tìm kiếm theo tên, mô tả, ID" />
            </form>

            <a class="btn btn-ghost" asp-action="Index">
                Quay lại danh sách đang hiển thị
            </a>
        </div>
    </div>

    <div id="bulkbar" class="bulkbar">
        <div class="bulk-left">
            <strong id="selectedCount">0</strong> đã chọn
            <button type="button" class="btn btn-ghost" id="clearSelect">Bỏ chọn</button>
        </div>

        <form id="bulkRestoreForm" method="post" asp-action="BulkRestore">
            @Html.AntiForgeryToken()
            <input type="hidden" name="ids" id="bulkIds" />
            <button type="button" class="btn btn-primary" id="openBulkRestore">Khôi phục đã chọn</button>
        </form>
    </div>

    <div class="card">
        <table class="table">
            <thead>
                <tr>
                    <th class="cell-check">
                        <input type="checkbox" class="checkbox" id="checkAll" />
                    </th>
                    <th>Tên sách</th>
                    <th>Danh mục</th>
                    <th>NXB</th>
                    <th>Giá</th>
                    <th>Tồn kho</th>
                    <th class="cell-actions">Hành vi</th>
                </tr>
            </thead>
            <tbody>
                @if (Model == null || Model.Count == 0)
                {
                    <tr>
                        <td colspan="7" style="text-align:center; color:#667085; padding:28px;">
                            Không có sách nào đang ẩn.
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var b in Model)
                    {
                        <tr>
                            <td class="cell-check">
                                <input type="checkbox" class="checkbox row-check" value="@b.BookID" />
                            </td>
                            <td>
                                <div class="cat">
                                    <div class="badge">B</div>
                                    <div class="cat-name">
                                        <strong>@b.Title</strong>
                                        <span>id#@b.BookID</span>
                                    </div>
                                </div>
                            </td>
                            <td style="color:#667085;">
                                @b.Category?.Name
                            </td>
                            <td style="color:#667085;">
                                @b.Publisher?.Name
                            </td>
                            <td>
                                @b.Price.ToString("N0") ₫
                            </td>
                            <td>
                                @b.Stock
                            </td>
                            <td class="cell-actions">
                                <div class="actions">
                                    <form asp-action="Restore" method="post" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@b.BookID" />
                                        <button type="submit" class="icon-btn" title="Khôi phục sách">
                                            <svg class="icon" viewBox="0 0 24 24" fill="none">
                                                <path d="M12 5v14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                                                <path d="M5 12l7-7 7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const checkAll = document.getElementById('checkAll');
            const checks = () => Array.from(document.querySelectorAll('.row-check'));
            const bulkbar = document.getElementById('bulkbar');
            const selectedCount = document.getElementById('selectedCount');
            const bulkIds = document.getElementById('bulkIds');
            const clearBtn = document.getElementById('clearSelect');

            function refreshBulk() {
                const selected = checks().filter(x => x.checked).map(x => x.value);
                selectedCount.textContent = selected.length;
                bulkIds.value = selected.join(',');
                bulkbar.classList.toggle('show', selected.length > 0);
                if (checkAll) checkAll.checked = selected.length > 0 && selected.length === checks().length;
            }

            if (checkAll) {
                checkAll.addEventListener('change', function () {
                    checks().forEach(x => x.checked = checkAll.checked);
                    refreshBulk();
                });
            }

            document.addEventListener('change', function (e) {
                if (e.target && e.target.classList.contains('row-check')) refreshBulk();
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', function () {
                    checks().forEach(x => x.checked = false);
                    if (checkAll) checkAll.checked = false;
                    refreshBulk();
                });
            }

            refreshBulk();
        })();

        (function () {
            const openBulk = document.getElementById('openBulkRestore');
            const bulkHidden = document.getElementById('bulkIds');

            if (openBulk && bulkHidden) {
                openBulk.addEventListener('click', function () {
                    const ids = (bulkHidden.value || '').trim();
                    if (!ids) return;
                    const form = document.getElementById('bulkRestoreForm');
                    form.submit();
                });
            }
        })();
    </script>
}

