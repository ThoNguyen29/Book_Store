@model Book_Store.Models.Book
@{
    Layout = "~/Views/Shared/_Admin_Layout.cshtml";
    ViewData["Title"] = "Sửa sản phẩm";

    var staticImages = ViewBag.StaticImages as List<string> ?? new List<string>();
    var images = Model.BookImages?.OrderBy(x => x.SortOrder).ToList() ?? new List<Book_Store.Models.BookImage>();

    // giữ lại query để quay lại đúng filter (nếu có)
    string q = Context.Request.Query["q"];
    string categoryId = Context.Request.Query["categoryId"];
    string publisherId = Context.Request.Query["publisherId"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-forms.css" asp-append-version="true" />
}

<div class="admin-page">
    <div class="page-header">
        <h1 class="page-title">Sửa sản phẩm</h1>

        <a class="btn btn-ghost"
           asp-action="Index"
           asp-route-q="@q"
           asp-route-categoryId="@categoryId"
           asp-route-publisherId="@publisherId">Quay lại</a>
    </div>

    <div class="card">
        <div class="card-body">
            <form class="form" asp-action="Edit" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="BookID" />

                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div style="display:grid; grid-template-columns: minmax(0,2fr) minmax(0,1.4fr); gap:24px; align-items:flex-start;">
                    <div>
                        <div class="field">
                            <div class="label">Tên sách</div>
                            <input class="input" asp-for="Title" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="field">
                            <div class="label" style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Tác giả</span>
                                <button type="button" class="btn btn-ghost" id="btnAddAuthor">+ Thêm</button>
                            </div>

                            <select id="AuthorSelect"
                                    name="authorIds"
                                    multiple
                                    class="input"
                                    asp-items="(MultiSelectList)ViewBag.Authors">
                            </select>

                            <div class="hint">Giữ Ctrl (hoặc Cmd) để chọn nhiều tác giả.</div>
                        </div>

                        <div id="modalAuthor"
                             style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;">
                            <div style="max-width:520px; margin:10vh auto; background:#fff; border-radius:14px; padding:18px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>Thêm tác giả</strong>
                                    <button type="button" class="btn btn-ghost" id="closeAuthor">×</button>
                                </div>

                                <div style="margin-top:12px;">
                                    <input class="input" id="authorName" placeholder="Tên tác giả" />
                                </div>

                                <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;">
                                    <button type="button" class="btn btn-ghost" id="cancelAuthor">Hủy</button>
                                    <button type="button" class="btn btn-primary" id="saveAuthor">Lưu</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="field">
                            <div class="label">Trạng thái</div>
                            <select class="input" asp-for="IsActive">
                                <option value="true">Hiển thị</option>
                                <option value="false">Ẩn</option>
                            </select>
                            <span asp-validation-for="IsActive" class="text-danger"></span>
                        </div>

                        <div class="field">
                            <div class="label" style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Danh mục</span>
                                <button type="button" class="btn btn-ghost" id="btnAddCategory">+ Thêm</button>
                            </div>

                            <select id="CategorySelect"
                                    class="input"
                                    asp-for="CategoryID"
                                    asp-items="ViewBag.CategoryID">
                                <option value="">-- Chọn danh mục --</option>
                            </select>
                            <span asp-validation-for="CategoryID" class="text-danger"></span>
                        </div>

                        <div id="modalCategory"
                             style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:9999;">
                            <div style="max-width:520px; margin:10vh auto; background:#fff; border-radius:14px; padding:18px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>Thêm danh mục</strong>
                                    <button type="button" class="btn btn-ghost" id="closeCategory">×</button>
                                </div>

                                <div style="margin-top:12px;">
                                    <input class="input" id="categoryName" placeholder="Tên danh mục" />
                                </div>

                                <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;">
                                    <button type="button" class="btn btn-ghost" id="cancelCategory">Hủy</button>
                                    <button type="button" class="btn btn-primary" id="saveCategory">Lưu</button>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <div class="label" style="display:flex; justify-content:space-between; align-items:center;">
                                <span>Nhà xuất bản</span>
                                <button type="button" class="btn btn-ghost" id="btnAddPublisher">+ Thêm</button>
                            </div>

                            <select class="input" asp-for="PublisherID" asp-items="ViewBag.PublisherID">
                                <option value="">-- Chọn NXB --</option>
                            </select>
                            <span asp-validation-for="PublisherID" class="text-danger"></span>
                        </div>

                        <div id="modalPublisher"
                             style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35);">
                            <div style="max-width:520px; margin:10vh auto; background:#fff; border-radius:14px; padding:18px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong>Thêm nhà xuất bản</strong>
                                    <button type="button" class="btn btn-ghost" id="closePublisher">×</button>
                                </div>
                                <div style="margin-top:12px;">
                                    <input class="input" id="publisherName" placeholder="Tên nhà xuất bản" />
                                </div>
                                <div style="margin-top:14px; display:flex; gap:10px; justify-content:flex-end;">
                                    <button type="button" class="btn btn-ghost" id="cancelPublisher">Hủy</button>
                                    <button type="button" class="btn btn-primary" id="savePublisher">Lưu</button>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:16px; flex-wrap:wrap;">
                            <div class="field" style="flex:1; min-width:140px;">
                                <div class="label">Giá</div>
                                <input class="input" asp-for="Price" />
                                <span asp-validation-for="Price" class="text-danger"></span>
                            </div>
                            <div class="field" style="flex:1; min-width:140px;">
                                <div class="label">Tồn kho</div>
                                <input class="input" asp-for="Stock" />
                                <span asp-validation-for="Stock" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr />

                <div class="field">
                    <div class="label">Mô tả</div>
                    <textarea class="input" asp-for="Description" id="DescriptionEditor" rows="6"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <hr />

                <!-- ẢNH HIỆN CÓ -->
                <div class="field">
                    <div class="label">Ảnh hiện có (chọn bìa / chọn xóa)</div>

                    @if (images.Count == 0)
                    {
                        <div class="hint">Chưa có ảnh.</div>
                    }
                    else
                    {
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px;">
                            @foreach (var img in images)
                            {
                                <label style="border:1px solid #eaecf0; border-radius:12px; padding:10px; display:grid; gap:8px;">
                                    <img src="@img.ImagePath"
                                         style="width:100%; height:110px; object-fit:cover; border-radius:10px;" />

                                    <div style="font-size:12px; color:#667085; word-break:break-all;">@img.ImagePath</div>

                                    <div style="display:flex; gap:10px; flex-wrap:wrap; font-size:12px;">
                                        <label>
                                            <input type="radio"
                                                   name="primaryImageId"
                                                   value="@img.BookImageID"
                                                   checked="@(img.IsPrimary)" />
                                            Ảnh bìa
                                        </label>

                                        <label style="color:#ef4444;">
                                            <input type="checkbox" name="deleteImageIds" value="@img.BookImageID" />
                                            Xóa
                                        </label>
                                    </div>
                                </label>
                            }
                        </div>
                    }
                </div>

                <hr />

                <!-- THÊM ẢNH MỚI (GIỐNG TRANG TẠO) -->
                <div class="field">
                    <div class="label">Thêm ảnh từ thiết bị</div>
                    <input class="input" type="file" name="uploadFiles" multiple accept="image/*" />
                </div>

                <div class="field">
                    <div class="label">Thêm ảnh từ URL (mỗi dòng 1 URL)</div>
                    <textarea class="input" name="imageUrls" rows="4" placeholder="https://..."></textarea>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <label><input type="radio" name="urlMode" value="keep" checked /> Lưu link</label>
                        <label><input type="radio" name="urlMode" value="download" /> Tải về lưu local</label>
                    </div>
                </div>

                <div class="field">
                    <div class="label" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Thêm ảnh có sẵn trong project</span>
                        <button type="button" class="btn btn-ghost" id="toggleStaticImages">Chọn ảnh từ project</button>
                    </div>

                    <div id="staticImagesPanel" style="display:none; margin-top:10px;">
                        @if (staticImages.Count == 0)
                        {
                            <div class="hint">Không có ảnh trong /wwwroot/images/books/</div>
                        }
                        else
                        {
                            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:10px;">
                                @foreach (var p in staticImages)
                                {
                                    <label style="border:1px solid #eaecf0; border-radius:12px; padding:10px; display:grid; gap:8px;">
                                        <input type="checkbox" name="staticImages" value="@p" />
                                        <img src="@p" style="width:100%; height:90px; object-fit:cover; border-radius:10px;" />
                                        <div style="font-size:12px; color:#667085; word-break:break-all;">@p</div>
                                    </label>
                                }
                            </div>
                        }
                    </div>
                </div>

                <input type="hidden" name="primaryChoice" id="primaryChoice" value="auto" />

                <div class="field">
                    <div class="label">Ảnh mới (xem trước + chọn làm bìa)</div>
                    <div id="newPreviewGrid"
                         style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:10px;">
                    </div>
                    <div class="hint">Nếu chọn bìa từ ảnh mới, hệ thống sẽ set bìa theo lựa chọn này sau khi lưu.</div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                    <a class="btn btn-ghost"
                       asp-action="Index"
                       asp-route-q="@q"
                       asp-route-categoryId="@categoryId"
                       asp-route-publisherId="@publisherId">Hủy</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.ckeditor.com/4.22.1/standard/ckeditor.js"></script>
    <script>
        CKEDITOR.config.versionCheck = false;
        CKEDITOR.replace('DescriptionEditor', {
            height: 520,
            removePlugins: 'notification,notificationaggregator',
            toolbar: [
                { name: 'clipboard', items: ['Undo', 'Redo'] },
                { name: 'styles', items: ['Format', 'Font', 'FontSize'] },
                { name: 'basicstyles', items: ['Bold', 'Italic', 'Underline', 'Strike', 'RemoveFormat'] },
                { name: 'paragraph', items: ['NumberedList', 'BulletedList', '-', 'Outdent', 'Indent', '-', 'JustifyLeft', 'JustifyCenter', 'JustifyRight', 'JustifyBlock'] },
                { name: 'links', items: ['Link', 'Unlink'] },
                { name: 'insert', items: ['Table', 'HorizontalRule'] },
                { name: 'tools', items: ['Maximize', 'Source'] }
            ]
        });
    </script>
    <script>
        (function () {
            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenEl ? tokenEl.value : "";

            // Toggle panel ảnh static
            const toggleBtn = document.getElementById('toggleStaticImages');
            const staticPanel = document.getElementById('staticImagesPanel');
            if (toggleBtn && staticPanel) {
                toggleBtn.addEventListener('click', () => {
                    staticPanel.style.display = (staticPanel.style.display === 'none' || !staticPanel.style.display) ? 'block' : 'none';
                });
            }

            // Quick create Publisher
            const modalP = document.getElementById('modalPublisher');
            const btnOpenP = document.getElementById('btnAddPublisher');
            const btnCloseP = document.getElementById('closePublisher');
            const btnCancelP = document.getElementById('cancelPublisher');
            const btnSaveP = document.getElementById('savePublisher');
            const inputP = document.getElementById('publisherName');
            const selectP = document.querySelector('select[name="PublisherID"]');

            function openModal(el) { if (el) el.style.display = 'block'; }
            function closeModal(el) { if (el) el.style.display = 'none'; }

            if (btnOpenP) btnOpenP.addEventListener('click', () => { openModal(modalP); if (inputP) { inputP.value = ''; inputP.focus(); } });
            if (btnCloseP) btnCloseP.addEventListener('click', () => closeModal(modalP));
            if (btnCancelP) btnCancelP.addEventListener('click', () => closeModal(modalP));

            if (btnSaveP) btnSaveP.addEventListener('click', async function () {
                const name = (inputP?.value || '').trim();
                if (!name) return;

                const body = new URLSearchParams();
                body.append('name', name);

                const res = await fetch('/Books/QuickCreatePublisher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: body.toString()
                });

                if (!res.ok) return;

                const data = await res.json(); // {id,text}
                const opt = Array.from(selectP.options).find(o => o.value == String(data.id));
                if (!opt) {
                    const o = document.createElement('option');
                    o.value = data.id;
                    o.textContent = data.text;
                    selectP.appendChild(o);
                }
                selectP.value = data.id;
                closeModal(modalP);
            });

            // Quick create Author
            const mA = document.getElementById('modalAuthor');
            const openA = document.getElementById('btnAddAuthor');
            const closeA = document.getElementById('closeAuthor');
            const cancelA = document.getElementById('cancelAuthor');
            const saveA = document.getElementById('saveAuthor');
            const authorName = document.getElementById('authorName');
            const authorSelect = document.getElementById('AuthorSelect');

            if (openA) openA.addEventListener('click', () => { openModal(mA); if (authorName) { authorName.value = ''; authorName.focus(); } });
            if (closeA) closeA.addEventListener('click', () => closeModal(mA));
            if (cancelA) cancelA.addEventListener('click', () => closeModal(mA));

            if (saveA) saveA.addEventListener('click', async () => {
                const name = (authorName?.value || '').trim();
                if (!name) return;

                const body = new URLSearchParams();
                body.append('name', name);

                const res = await fetch('/Books/QuickCreateAuthor', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: body.toString()
                });

                if (!res.ok) return;

                const data = await res.json(); // {id,text}

                let opt = Array.from(authorSelect.options).find(o => o.value === String(data.id));
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = data.id;
                    opt.textContent = data.text;
                    authorSelect.appendChild(opt);
                }
                opt.selected = true;

                closeModal(mA);
            });

            // Quick create Category
            const mC = document.getElementById('modalCategory');
            const openC = document.getElementById('btnAddCategory');
            const closeC = document.getElementById('closeCategory');
            const cancelC = document.getElementById('cancelCategory');
            const saveC = document.getElementById('saveCategory');
            const categoryName = document.getElementById('categoryName');
            const categorySelect = document.getElementById('CategorySelect');

            if (openC) openC.addEventListener('click', () => { openModal(mC); if (categoryName) { categoryName.value = ''; categoryName.focus(); } });
            if (closeC) closeC.addEventListener('click', () => closeModal(mC));
            if (cancelC) cancelC.addEventListener('click', () => closeModal(mC));

            if (saveC) saveC.addEventListener('click', async () => {
                const name = (categoryName?.value || '').trim();
                if (!name) return;

                const body = new URLSearchParams();
                body.append('name', name);

                const res = await fetch('/Books/QuickCreateCategory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: body.toString()
                });

                if (!res.ok) return;

                const data = await res.json(); // {id,text}

                let opt = Array.from(categorySelect.options).find(o => o.value === String(data.id));
                if (!opt) {
                    opt = document.createElement('option');
                    opt.value = data.id;
                    opt.textContent = data.text;
                    categorySelect.appendChild(opt);
                }
                categorySelect.value = String(data.id);

                closeModal(mC);
            });
        })();
    </script>
    <script>
        (function () {
            const fileInput = document.querySelector('input[name="uploadFiles"]');
            const urlTextarea = document.querySelector('textarea[name="imageUrls"]');
            const staticChecks = () => Array.from(document.querySelectorAll('input[name="staticImages"]:checked'));
            const urlModeRadios = () => Array.from(document.querySelectorAll('input[name="urlMode"]'));
            const grid = document.getElementById('newPreviewGrid');

            const primaryChoice = document.getElementById('primaryChoice');
            const primaryImageIdRadios = () => Array.from(document.querySelectorAll('input[name="primaryImageId"]'));

            function getUrlMode() {
                const r = urlModeRadios().find(x => x.checked);
                return r ? r.value : "keep";
            }

            function parseUrls(raw) {
                if (!raw) return [];
                return raw.split(/[\n\r;,]+/g).map(s => s.trim()).filter(Boolean);
            }

            function clearGrid() { grid.innerHTML = ""; }

            function addCard({ src, label, choiceValue }) {
                const wrap = document.createElement('label');
                wrap.style.border = "1px solid #eaecf0";
                wrap.style.borderRadius = "12px";
                wrap.style.padding = "10px";
                wrap.style.display = "grid";
                wrap.style.gap = "8px";

                const img = document.createElement('img');
                img.src = src;
                img.style.width = "100%";
                img.style.height = "110px";
                img.style.objectFit = "cover";
                img.style.borderRadius = "10px";

                const txt = document.createElement('div');
                txt.style.fontSize = "12px";
                txt.style.color = "#667085";
                txt.style.wordBreak = "break-all";
                txt.textContent = label;

                const rbWrap = document.createElement('div');
                rbWrap.style.display = "flex";
                rbWrap.style.gap = "10px";
                rbWrap.style.fontSize = "12px";
                rbWrap.style.alignItems = "center";

                const rb = document.createElement('input');
                rb.type = "radio";
                rb.name = "primaryNewRadio";
                rb.value = choiceValue;

                rb.addEventListener('change', () => {
                    // chọn bìa từ ảnh mới => clear chọn bìa ảnh cũ
                    primaryImageIdRadios().forEach(r => r.checked = false);
                    primaryChoice.value = rb.value;
                });

                const rbLabel = document.createElement('span');
                rbLabel.textContent = "Chọn làm bìa";

                rbWrap.appendChild(rb);
                rbWrap.appendChild(rbLabel);

                wrap.appendChild(img);
                wrap.appendChild(txt);
                wrap.appendChild(rbWrap);

                grid.appendChild(wrap);
            }

            function rebuild() {
                clearGrid();
                primaryChoice.value = "auto";

                const files = fileInput && fileInput.files ? Array.from(fileInput.files) : [];
                files.forEach((f, i) => addCard({
                    src: URL.createObjectURL(f),
                    label: `[Upload] ${f.name}`,
                    choiceValue: `upload:${i}`
                }));

                const urls = parseUrls(urlTextarea ? urlTextarea.value : "");
                urls.forEach((u, i) => addCard({
                    src: u,
                    label: `[URL-${getUrlMode()}] ${u}`,
                    choiceValue: (getUrlMode() === "download" ? `download:${i}` : `url:${i}`)
                }));

                const statics = staticChecks().map(x => x.value);
                statics.forEach((p, i) => addCard({
                    src: p,
                    label: `[Static] ${p}`,
                    choiceValue: `static:${i}`
                }));
            }

            if (fileInput) fileInput.addEventListener('change', rebuild);
            if (urlTextarea) urlTextarea.addEventListener('input', rebuild);
            urlModeRadios().forEach(r => r.addEventListener('change', rebuild));

            document.addEventListener('change', (e) => {
                if (e.target && e.target.name === "staticImages") rebuild();

                // user chọn bìa ảnh cũ => ưu tiên primaryImageId, reset primaryChoice
                if (e.target && e.target.name === "primaryImageId") primaryChoice.value = "auto";
            });

            rebuild();
        })();
    </script>
}